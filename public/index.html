<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Twitch Klip Oynatıcı</title>
<style>
  body {
    margin:0; padding:0; background:#111; color:#eee; font-family:sans-serif;
    display:flex; flex-direction:column; height:100vh;
  }
  header {
    background:#222; padding:10px; display:flex; gap:10px; align-items:center;
    justify-content:center; flex-wrap:wrap;
  }
  input, button {
    padding:6px 10px; border:none; border-radius:5px; font-size:14px;
  }
  button { background:#333; color:#eee; cursor:pointer; }
  button:hover { background:#555; }
  
  /* Ana içerik flex yapısı */
  #mainContent {
    flex:1;
    display:flex;
    overflow:hidden;
  }

  #player {
    flex:2;
    position:relative;
    background:#000;
  }
  #player iframe {
    position:absolute; top:0; left:0; width:100%; height:100%; border:0;
  }

  #clipList {
    flex:1;
    background:#222;
    overflow-y:auto;
    padding:10px;
    color:#0ff;
  }
  #clipList a {
    display:block;
    color:#0ff;
    margin-bottom:5px;
    text-decoration:none;
  }
  #clipList a:hover {
    text-decoration:underline;
  }

  #controls {
    display:flex; justify-content:center; gap:12px; padding:10px; background:#222;
  }
</style>
</head>
<body>
<header>
  Yayıncı: <input id="broadcasterInput" type="text" value="pourselen">
  Başlangıç: <input id="startDate" type="date">
  Bitiş: <input id="endDate" type="date">
  <button id="loadBtn">Getir</button>
  <span id="clipCount"></span>
</header>

<div id="mainContent">
  <div id="player"></div>
  <div id="clipList"></div>
</div>

<div id="controls">
  <button id="prev">⏮ Önceki</button>
  <span id="status"></span>
  <input id="jumpInput" type="number" min="1" style="width:60px;">
  <button id="jumpBtn">Git</button>
  <button id="next">⏭ Sonraki</button>
</div>

<script>
let clips = [];
let current = 0;
const parentDomain = window.location.hostname.replace(/^www\./, "");

// Klipleri yükleme ve listeleme
async function loadClips() {
  const broadcaster = document.getElementById("broadcasterInput").value;
  const start = document.getElementById("startDate").value;
  const end = document.getElementById("endDate").value;

  let url = `/api/clips?broadcaster=${broadcaster}`;
  if (start) url += `&start=${new Date(start).toISOString()}`;
  if (end) url += `&end=${new Date(end).toISOString()}`;

  const res = await fetch(url);
  const data = await res.json();
  if(!data || !data.data) {
    alert("Klip bulunamadı!");
    return;
  }

  clips = data.data;
  current = 0;
  document.getElementById("clipCount").innerText = `Toplam: ${data.total} klip`;
  showClip(current);
  listClips();
}

// Oynatıcıda klibi göster
function showClip(index) {
  const playerDiv = document.getElementById("player");
  playerDiv.innerHTML = "";
  const clip = clips[index];
  if (!clip) return;
  const iframe = document.createElement("iframe");
  iframe.src = `https://clips.twitch.tv/embed?clip=${clip.id}&parent=${parentDomain}&autoplay=true`;
  iframe.allowFullscreen = true;
  playerDiv.appendChild(iframe);
  document.getElementById("status").innerText = `${index+1}/${clips.length}`;
}

// Sağda listeleme
function listClips() {
  const listDiv = document.getElementById("clipList");
  listDiv.innerHTML = "";
  clips.forEach((clip, index) => {
    const a = document.createElement("a");
    a.href = `https://clips.twitch.tv/${clip.id}`;
    a.target = "_blank";
    a.innerText = `${index+1}. ${clip.title || clip.id}`;
    listDiv.appendChild(a);
  });
}

// Kontroller
function prevClip(){
  if(clips.length===0) return;
  current = (current - 1 + clips.length) % clips.length;
  showClip(current);
}

function nextClip(){
  if(clips.length===0) return;
  current = (current + 1) % clips.length;
  showClip(current);
}

function jumpClip(){
  const val = parseInt(document.getElementById("jumpInput").value);
  if(!val || val < 1 || val > clips.length) return;
  current = val-1;
  showClip(current);
}

// Eventler
document.getElementById("prev").addEventListener("click", prevClip);
document.getElementById("next").addEventListener("click", nextClip);
document.getElementById("jumpBtn").addEventListener("click", jumpClip);
document.getElementById("loadBtn").addEventListener("click", loadClips);

window.addEventListener("keydown", (e)=>{
  if(e.key==="1") prevClip();
  if(e.key==="2") nextClip();
});

loadClips();
</script>
</body>
</html>
