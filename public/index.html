<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<title>Twitch Klip Oynatƒ±cƒ±</title>
<style>
  body {
    margin:0; padding:0; background:#111; color:#eee; font-family:sans-serif;
    display:flex; flex-direction:column; height:100vh;
  }
  header {
    background:#222; padding:10px; display:flex; gap:10px; align-items:center;
    justify-content:center; flex-wrap:wrap;
  }
  input, button {
    padding:6px 10px; border:none; border-radius:5px; font-size:14px;
  }
  button { background:#333; color:#eee; cursor:pointer; }
  button:hover { background:#555; }
  #player { flex:1; position:relative; background:#000; }
  #player iframe {
    position:absolute; top:0; left:0; width:100%; height:100%; border:0;
  }
  #controls {
    display:flex; justify-content:center; gap:12px; padding:10px; background:#222;
  }
</style>
</head>
<body>
<header>
  Yayƒ±ncƒ±: <input id="broadcasterInput" type="text" value="pourselen">
  Ba≈ülangƒ±√ß: <input id="startDate" type="date">
  Biti≈ü: <input id="endDate" type="date">
  <button id="loadBtn">Getir</button>
  <span id="clipCount"></span>
  <button id="openAllBtn" title="T√ºm klipleri yeni sekmede a√ß">üóî</button>
</header>

<div id="player"></div>

<div id="controls">
  <button id="prev">‚èÆ √ñnceki</button>
  <span id="status"></span>
  <input id="jumpInput" type="number" min="1" style="width:60px;">
  <button id="jumpBtn">Git</button>
  <button id="next">‚è≠ Sonraki</button>
</div>

<script>
let clips = [];
let current = 0;
const parentDomain = window.location.hostname.replace(/^www\./, "");

// Klipleri y√ºkle
async function loadClips() {
  const broadcaster = document.getElementById("broadcasterInput").value;
  const start = document.getElementById("startDate").value;
  const end = document.getElementById("endDate").value;

  let url = `/api/clips?broadcaster=${broadcaster}`;
  if (start) url += `&start=${new Date(start).toISOString()}`;
  if (end) url += `&end=${new Date(end).toISOString()}`;

  const res = await fetch(url);
  const data = await res.json();
  if(!data || !data.data || data.data.length === 0) {
    alert("Klip bulunamadƒ±!");
    return;
  }
  clips = data.data;
  current = 0;
  document.getElementById("clipCount").innerText = `Toplam: ${data.total} klip`;
  showClip(current);
}

// Mevcut klibi g√∂ster
function showClip(index) {
  const playerDiv = document.getElementById("player");
  playerDiv.innerHTML = "";
  const clip = clips[index];
  if (!clip) return;
  const iframe = document.createElement("iframe");
  iframe.src = `https://clips.twitch.tv/embed?clip=${clip.id}&parent=${parentDomain}&autoplay=true`;
  iframe.allowFullscreen = true;
  playerDiv.appendChild(iframe);

  document.getElementById("status").innerText = `${index+1}/${clips.length}`;
}

// √ñnceki/sonraki klip
function prevClip(){
  if(clips.length===0) return;
  current = (current - 1 + clips.length) % clips.length;
  showClip(current);
}

function nextClip(){
  if(clips.length===0) return;
  current = (current + 1) % clips.length;
  showClip(current);
}

// Jump input
function jumpClip(){
  const val = parseInt(document.getElementById("jumpInput").value);
  if(!val || val < 1 || val > clips.length) return;
  current = val-1;
  showClip(current);
}

// T√ºm klipleri yeni sekmede a√ß
function openAllClips() {
  if(clips.length === 0) return;
  clips.forEach((clip, i) => {
    setTimeout(() => {
      const url = `https://clips.twitch.tv/${clip.id}`;
      window.open(url, "_blank");
    }, i * 100); // 100ms aralƒ±k ile a√ß, pop-up engellemeyi azaltƒ±r
  });
}

// Event listenerler
document.getElementById("prev").addEventListener("click", prevClip);
document.getElementById("next").addEventListener("click", nextClip);
document.getElementById("jumpBtn").addEventListener("click", jumpClip);
document.getElementById("loadBtn").addEventListener("click", loadClips);
document.getElementById("openAllBtn").addEventListener("click", openAllClips);

window.addEventListener("keydown", (e)=>{
  if(e.key==="1") prevClip();
  if(e.key==="2") nextClip();
});

// Sayfa y√ºklendiƒüinde default klipleri getir
loadClips();
</script>
</body>
</html>
